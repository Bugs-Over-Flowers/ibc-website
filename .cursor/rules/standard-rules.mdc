---
alwaysApply: true
---

# IBC Website Development Rules

## Commit Message Convention

All commit messages **MUST** follow this format: `<type>: <description>`

**Commit Types:**

- `feat:` new feature
- `fix:` bug fix
- `docs:` documentation updates
- `style:` formatting (no code change)
- `refactor:` code restructure (no feature/bug fix)
- `test:` add/modify tests
- `chore:` maintenance tasks
- `build:` build system changes
- `perf:` performance improvement

**Examples:**

- `feat: add user authentication`
- `fix: resolve infinite loop in data fetching`
- `docs: update API documentation`
- `refactor: extract validation logic to utility`

## Tech Stack

- **Framework:** Next.js 15 (App Router) + React 19 + Turbopack
- **Runtime:** Bun
- **Language:** TypeScript (strict mode)
- **Styling:** Tailwind CSS v4 with oklch design tokens
- **UI:** shadcn/ui (Base-ui primitives)
- **Forms:** TanStack Form with Zod validation
- **Backend:** Supabase (PostgreSQL)
- **Testing:** Vitest (unit), Cypress (component/e2e)
- **Linting:** Biome (replaces ESLint + Prettier)

## File Structure Rules

### Component Placement

- Route-specific components → `app/[route]/_components/`
- Forms → `app/[route]/_components/forms/`
- Route-specific hooks → `app/[route]/_hooks/`
- Global/reusable components → `src/components/`

### Server Logic Placement

- Feature-specific server logic → `src/server/[feature]/`
- Mutations (POST, PUT, DELETE) → `src/server/[feature]/mutations/<filename>.ts`
- Queries (GET) → `src/server/[feature]/queries/<filename>.ts`
- Shared server logic → `src/server/utils.ts`
- Feature-specific utils → `src/server/[feature]/utils.ts`

## Code Conventions

### Imports & Paths

- **ALWAYS** use `@/` path alias (maps to `./src/`)
- Never use relative paths like `../../` when `@/` is available
- Organize imports: external packages → internal modules → components → types
- Biome auto-sorts imports on save

### Formatting

- **Indentation:** 2 spaces (enforced by Biome)
- **Quotes:** Double quotes for strings
- **Semicolons:** Required
- **Tailwind classes:** Auto-sorted by Biome's `useSortedClasses` rule

### Naming Conventions

- **Files:** camelCase for utilities, PascalCase for components
- **Components:** PascalCase (e.g., `UserProfile.tsx`)
- **Hooks:** camelCase with `use` prefix (e.g., `useUserData.ts`)
- **Server actions:** camelCase verbs (e.g., `createUser`, `updateProfile`)
- **Types/Interfaces:** PascalCase (e.g., `User`, `CreateUserInput`)
- **Constants:** UPPER_SNAKE_CASE (e.g., `MAX_FILE_SIZE`)

### Styling

- Use `cn()` from `@/lib/utils` for conditional Tailwind classes
- Use `cva()` from `class-variance-authority` for component variants
- Design tokens in `globals.css` use oklch colors as CSS variables

### TypeScript

- **Strict mode enabled** - all type errors must be resolved
- Use `type` for object shapes, `interface` for extensible contracts
- Prefer explicit return types on exported functions
- Use generated types from `@/lib/supabase/db.types.ts` for database tables
- Server functions use `ServerFunctionResult<T, E>` from `@/lib/server/types`

### Components

- **Server Components by default** - only add `"use client"` when needed
- Client-side requirements: hooks, event handlers, browser APIs, context
- Use React 19 patterns: `use` hook for promises in client components
- shadcn/ui components use `data-slot` attributes and Base-ui primitives
- Add new UI components: `bunx --bun shadcn@latest add <component>`

## Client-Side Action Handling Rules

### `tryCatch` Utility

- **MUST** wrap server actions that throw errors
- Use with `useAction` hook for button-triggered mutations
- Use inline for form submissions
- Returns `{ error, data, success }` tuple

**Example (inline use):**
```typescript
import tryCatch from "@/lib/server/tryCatch";
const { error, data, success } = await tryCatch(createUser(input));
if (!success) {
  form.setErrorMap({ onSubmit: error });
  return;
}
```

### `useAction` Hook

- **ONLY** for button-triggered mutations (not form submissions)
- **MUST** wrap server action with `tryCatch()` before passing to `useAction`
- Returns: `{ execute, isPending, data, error, reset }`

**Example:**
```typescript
const { execute, isPending } = useAction(tryCatch(deleteUser), {
  onSuccess: () => router.push("/users"),
  onError: (err) => toast.error(err),
});
```

## Validation Rules

### Zod Schemas

- **MUST** use Zod schemas for all forms integrated with TanStack Forms
- **MUST** import reusable schemas from `@/lib/validation/utils`:
  - `phoneSchema` - Philippine phone: +639XXXXXXXXX or 09XXXXXXXXX
  - `emailSchema` - Standard email validation

## Caching Rules

### "use cache" Directive

- Use `"use cache"` inside query functions, Server Components, or at file level
- Add `cacheLife()` for cache duration in seconds
- Add `cacheTag()` for cache invalidation tags
- **NOTE**: Most files cannot be cached due to Supabase cookie requirements for SSR
- When cookies are needed, get them at page level and pass to query function

**Example:**
```typescript
// In page.tsx
const cookieStore = await cookies();
const data = await getCachedData(cookieStore.getAll());

// In query file
export async function getCachedData(requestCookies: RequestCookie[]) {
  "use cache";
  const supabase = await createClient(requestCookies);
  // ...
}
```

## Loading States Rules

### Server Components

- Use `<Suspense>` with fallback components
- Use `loading.tsx` files for route-level loading states
- For multiple queries: `await Promise.all([query1(), query2()])`

### Client Components

- Use `use` hook from React for client-side promise handling
- Use `<Suspense>` with fallback components
- Use `loading.tsx` files for route-level loading states

## Toast Notifications Rules

- Use `sonner` library - `<Toaster />` is in root layout
- Prefer `useAction`'s toast options when available
- Manual usage: `toast.success()`, `toast.error()`, `toast.loading()`

## Environment Variables Rules

### Required Variables

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`

## Type Safety Rules

- **MUST** use generated types from `@/lib/supabase/db.types.ts`
- Regenerate types with: `bun run gen:types`
- Server functions use `ServerFunctionResult<T, E>` type from `@/lib/server/types`

## Error Handling Rules

- Server actions can throw errors freely
- **MUST** wrap with `tryCatch` on client side
- Check `success` property before accessing `data`
- Use discriminated union pattern: `{ success: true, data }` or `{ success: false, error }`

## Common Pitfalls to Avoid

1. **Don't use relative imports** when `@/` alias is available
2. **Don't add `"use client"`** unless component needs client-side features
3. **Don't use `createActionClient()`** in cached queries
4. **Don't use `createClient(requestCookies)`** for mutations
5. **Always wrap server actions with `tryCatch`** on the client side
6. **Always validate with Zod** before processing user input
7. **Don't forget `revalidatePath()`** after mutations that affect cached data
